import Strapi from '@strapi/client';
import fs from 'fs/promises';
import path from 'path';

async function generateTypes() {
  const strapiUrl = process.env.STRAPI_URL;
  const strapiToken = process.env.STRAPI_TOKEN;
  const outputPath = process.argv[2] || 'src/types/strapi-generated.ts';

  if (!strapiUrl || !strapiToken) {
    console.error('Error: STRAPI_URL and STRAPI_TOKEN environment variables are required.');
    process.exit(1);
  }

  try {
    console.log('Connecting to Strapi to fetch schemas...');
    const strapi = new Strapi(strapiUrl, {
        headers: {
          Authorization: `Bearer ${strapiToken}`,
        },
    });

    // Use the request method to get schemas from the admin endpoint
    const response = await strapi.request('GET', '/content-type-builder/content-types');
    
    // The response from this endpoint has a `data` property which is the array of schemas
    const schemas = response.data;

    if (!schemas || !Array.isArray(schemas)) {
      throw new Error('No schemas array returned from Strapi.');
    }

    console.log(`Successfully fetched ${schemas.length} schemas.`);

    let typesContent = '// Generated by scripts/generate-strapi-types.mjs\n// Do not edit this file manually.\n\n';

    // Loop over the array of schemas
    for (const schema of schemas) {
      // We only care about collectionTypes for now
      if (schema.schema.kind !== 'collectionType') {
        continue;
      }

      const interfaceName = schema.schema.displayName.replace(/[\s-]+/g, '');

      typesContent += `export interface ${interfaceName} {\n`;
      typesContent += `  id: number;\n`;
      typesContent += `  attributes: {\n`; // Strapi v4 nests attributes

      for (const attr in schema.schema.attributes) {
        const attribute = schema.schema.attributes[attr];
        let tsType = 'any';
        switch (attribute.type) {
          case 'string':
          case 'text':
          case 'email':
          case 'password':
          case 'richtext':
          case 'uid':
            tsType = 'string';
            break;
          case 'integer':
          case 'biginteger':
          case 'float':
          case 'decimal':
            tsType = 'number';
            break;
          case 'date':
          case 'datetime':
          case 'time':
            tsType = 'string'; // Or Date
            break;
          case 'boolean':
            tsType = 'boolean';
            break;
          case 'relation':
            tsType = attribute.relation === 'oneToMany' || attribute.relation === 'manyToMany' ? 'any[]' : 'any';
            break;
          case 'component':
            tsType = 'any'; // TODO: Generate component interfaces
            break;
          case 'media':
            tsType = attribute.multiple ? 'any[]' : 'any';
            break;
          case 'json':
            tsType = 'any';
            break;
        }
        typesContent += `    ${attr}: ${tsType};\n`;
      }
      typesContent += `  }\n`;
      typesContent += '}\n\n';
    }

    await fs.writeFile(path.resolve(outputPath), typesContent);
    console.log(`Successfully generated types at ${outputPath}`);

  } catch (error) {
    const errorMessage = error.response?.data?.error?.message || error.message;
    console.error('Failed to generate Strapi types:', errorMessage);
    process.exit(1);
  }
}

generateTypes();